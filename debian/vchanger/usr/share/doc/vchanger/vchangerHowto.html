<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
	<TITLE></TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.2  (Win32)">
	<META NAME="CREATED" CONTENT="20061109;11301500">
	<META NAME="CHANGEDBY" CONTENT="Josh Fisher">
	<META NAME="CHANGED" CONTENT="20100514;15455000">
	<META NAME="Info 1" CONTENT="">
	<META NAME="Info 2" CONTENT="">
	<META NAME="Info 3" CONTENT="">
	<META NAME="Info 4" CONTENT="">
	<META NAME="CHANGEDBY" CONTENT="Josh Fisher">
	<STYLE TYPE="text/css">
	<!--
		@page { margin: 0.79in }
		TD P { margin-left: 0.2in; margin-top: 0.01in; margin-bottom: 0.08in }
		TD P.western { font-family: "Times New Roman", serif; font-size: 12pt }
		H1 { margin-left: 0.2in; margin-bottom: 0.08in }
		H1.western { font-family: "Times New Roman", serif; font-size: 20pt }
		H1.cjk { font-family: "Lucida Sans Unicode"; font-size: 16pt }
		H1.ctl { font-family: "Tahoma"; font-size: 16pt }
		P { margin-left: 0.2in; margin-top: 0.01in; margin-bottom: 0.08in }
		P.western { font-family: "Times New Roman", serif; font-size: 12pt }
		H3 { margin-left: 0.2in; margin-bottom: 0.08in }
		H3.western { font-family: "Albany", sans-serif }
		H3.cjk { font-family: "HG Mincho Light J" }
		H3.ctl { font-family: "Arial Unicode MS" }
		PRE { margin-left: 0.4in }
		PRE.cjk { font-family: "NSimSun", monospace }
		TD P.col1-western { margin-left: 0.4in; font-family: "Times New Roman", serif; font-size: 12pt }
		TD P.col1-cjk { margin-left: 0.4in }
		TD P.col1-ctl { margin-left: 0.4in }
		P.text-body-indent-western { margin-bottom: 0.04in; font-family: "Times New Roman", serif; font-size: 12pt }
		P.text-body-indent-cjk { margin-bottom: 0.04in }
		P.text-body-indent-ctl { margin-bottom: 0.04in }
		P.text-body-indent-2-western { margin-left: 0.4in; margin-bottom: 0.04in; font-family: "Times New Roman", serif; font-size: 12pt }
		P.text-body-indent-2-cjk { margin-left: 0.4in; margin-bottom: 0.04in }
		P.text-body-indent-2-ctl { margin-left: 0.4in; margin-bottom: 0.04in }
		P.text-body-indent-3-western { margin-left: 0.6in; margin-bottom: 0.04in; font-family: "Times New Roman", serif; font-size: 12pt }
		P.text-body-indent-3-cjk { margin-left: 0.6in; margin-bottom: 0.04in }
		P.text-body-indent-3-ctl { margin-left: 0.6in; margin-bottom: 0.04in }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<P CLASS="western" STYLE="margin-top: 0.17in; page-break-after: avoid">
<FONT SIZE=5 STYLE="font-size: 20pt"><B>Vchanger Howto</B></FONT></P>
<H3 CLASS="western">Josh Fisher</H3>
<P CLASS="western" STYLE="margin-top: 0in; margin-bottom: 0in">&lt;jfisher
at jaybus dot com&gt;</P>
<P CLASS="western" STYLE="margin-top: 0in; margin-bottom: 0in"><BR>
</P>
<P CLASS="western" STYLE="margin-top: 0in; margin-bottom: 0in"><B>Revision
History</B></P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in">Revision
0.8.6 2010-05-14</P>
<P CLASS="text-body-indent-3-western">Documented changes related to
version 0.8.6 of the software.</P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in">Revision
0.8.5 2010-02-05</P>
<P CLASS="text-body-indent-3-western">Documented changes related to
version 0.8.5 of the software.</P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in">Revision
0.8.4 2009-12-02</P>
<P CLASS="text-body-indent-3-western">Documented changes related to
version 0.8.4 of the software.</P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in">Revision
0.8.3 2009-10-26</P>
<P CLASS="text-body-indent-3-western">Documented changes related to
version 0.8.3 of the software, which includes specifying magazine
partitions by UUID and the addition of the LISTMAGS command.</P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in">Revision
0.8.2 2009-04-14</P>
<P CLASS="text-body-indent-3-western">Fixed some config file typos in
the howto examples.</P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in">Revision
0.8.1 2009-01-27</P>
<P CLASS="text-body-indent-3-western">Documented addition of command
line flags for specifying uid and gid vchanger should run as when
invoked by root. Fixed examples to coincide with changes to the
by-label-fix udev rules for multi-magazine autochangers.</P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in">Revision
0.8.0 2008-10-01</P>
<P CLASS="text-body-indent-3-western">Initial beta release</P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in">The
vchanger utility implements the <A HREF="http://www.bacula.org/3.0.x-manuals/en/concepts/concepts/Autochanger_Resource.html#SECTION0018130000000000000000">Bacula
Autochanger Interface</A> API to provide a disk-based virtual
autochanger backup device for use with <A HREF="http://www.bacula.org/"><FONT FACE="Times New Roman, serif">Bacula</FONT></A><A HREF="http://www.bacula.org/"><SUB><FONT FACE="Times New Roman, serif">&reg;</FONT></SUB></A>,
an open source network backup solution.</P>
<P CLASS="western" STYLE="margin-top: 0.1in; margin-bottom: 0in"><BR>
</P>
<HR>
<H1 CLASS="western">Table of Contents</H1>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>1.
<A HREF="#introduction">Introduction</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>1.1
<A HREF="#copyright">Copyright And License</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>1.2.
<A HREF="#disclaimer">Disclaimer</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>1.3.
<A HREF="#credits">Credits / Contributors</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>1.4.
<A HREF="#feedback">Feedback</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>2.
<A HREF="#definitions">Definitions</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>3.
<A HREF="#overview">Overview</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>4.
<A HREF="#implementation">Virtual Autochanger Implementation</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>4.1.
<A HREF="#disk-changerDifferences">Differences Between vchanger and
disk-changer</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>4.2.
<A HREF="#virtual_magazines">Virtual Magazines</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>4.3.
<A HREF="#assigning_magazines">Assigning Magazines to an Autochanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>4.4.
<A HREF="#multi-magazine">Multi-magazine Autochangers</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>4.5.
<A HREF="#synch_bacula">Keeping Bacula In Synch With an Autochanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>5.
<A HREF="#install">Installing vchanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>5.1.
<A HREF="#install_win32">Installing the Windows Version</A></FONT></FONT></P>
<P CLASS="text-body-indent-3-western"><FONT FACE="Arial"><FONT SIZE=3>5.1.1.
<A HREF="#win32_build">Installing the Windows Version from Source</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>6.
<A HREF="#preparing">Preparing Removable Drives</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>6.1.
<A HREF="#preparing_linux">Preparing Drives for Linux</A></FONT></FONT></P>
<P CLASS="text-body-indent-3-western"><FONT FACE="Arial"><FONT SIZE=3>6.1.1.
<A HREF="#partition">Partitioning the Drive</A></FONT></FONT></P>
<P CLASS="text-body-indent-3-western"><FONT FACE="Arial"><FONT SIZE=3>6.1.2.
<A HREF="#formatting">Formatting the Partition Filesystem</A></FONT></FONT></P>
<P CLASS="text-body-indent-3-western"><FONT FACE="Arial"><FONT SIZE=3>6.1.3.
<A HREF="#mag_permissions">Setting Permissions For The Partition
Filesystem</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>6.2.
<A HREF="#preparing_win32">Preparing Drives for Windows</A></FONT></FONT></P>
<P CLASS="text-body-indent-3-western"><FONT FACE="Arial"><FONT SIZE=3>6.2.1.
<A HREF="#windows_uuid">Determining a Magazine Partition's UUID</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>7.
<A HREF="#mounting">Mounting Removable Disk Drives</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>7.1.
<A HREF="#udev">udev and Hot-swappable Drives</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>7.2.
<A HREF="#manual_mounting">Manually Mounting Drives</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>7.3.
<A HREF="#autofs">Using autofs to Mount Removable Drive Partitions</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western" STYLE="margin-left: 1.59in"><FONT FACE="Arial"><FONT SIZE=3>7.3.1.
<A HREF="#with_autofs">Configuring vchanger For Use With autofs</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>7.4.
<A HREF="#mounting_win32">Mounting Removable Drives On Windows</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>8.
<A HREF="#vchanger_config">Configuring vchanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>9.
<A HREF="#initialize">Initializing New Magazines</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>10.
<A HREF="#testing">Testing vchanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>11.
<A HREF="#configuring_bacula">Configuring Bacula To Use The
Autochanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>11.1.
<A HREF="#sd_config">Configuring the Bacula Storage Daemon</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>11.2.
<A HREF="#dir_config">Configuring the Bacula Director</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>11.3.
<A HREF="#bacula_interaction">Bacula / vchanger Interaction</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>12.
<A HREF="#using">Using The Autochanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>12.1.
<A HREF="#labeling_volumes">Labeling Volumes In New Magazines</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>12.2.
<A HREF="#insert_mag">Inserting Magazines</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>12.3.
<A HREF="#eject_mag">Ejecting Magazines</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>12.4.
<A HREF="#magazine_change">Changing Magazines</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>13.
<A HREF="#examples">Example Autochanger Configurations</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>13.1.
<A HREF="#example_single">Single-magazine Single-drive Autochanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>13.2.
<A HREF="#example_multi">Multi-magazine Multi-drive Autochanger</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>13.3.
<A HREF="#example_win32">Windows Autochangers</A></FONT></FONT></P>
<P CLASS="text-body-indent-western"><FONT FACE="Arial"><FONT SIZE=3>Appendix
A. <A HREF="#vchanger_commands">vchanger Commands</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>A.1.
<A HREF="#command_list">list Command</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>A.2.
<A HREF="#command_slots">slots Command</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>A.3.
<A HREF="#command_load">load Command</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>A.4.
<A HREF="#command_unload">unload Command</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>A.5.
<A HREF="#command_loaded">loaded Command</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>A.6.
<A HREF="#command_initmag">initmag Command</A></FONT></FONT></P>
<P CLASS="text-body-indent-2-western"><FONT FACE="Arial"><FONT SIZE=3>A.7.
<A HREF="#command_listmags">listmags Command</A></FONT></FONT></P>
<H1 CLASS="western"><A NAME="introduction"></A>1. Introduction</H1>
<P CLASS="western">This document describes how to utilize disk
storage, particularly removable disk storage devices, as media for a
backup solution using <A HREF="http://www.bacula.org/">Bacula</A>.
Bacula already includes a shell script named <I>disk-changer</I> that
provides for a disk-based virtual autochanger on Linux and most other
POSIX systems. The <I>disk-changer</I> script, as a part of the
Bacula distribution, has undergone extensive regression testing.
However, <I>disk-changer</I> is not designed to work with a pool of
multiple disk drives and does not emulate removable &ldquo;magazines&rdquo;.
Vchanger is an executable program written in C and C++ that extends
the functionality of <I>disk-changer</I> with the following features:</P>
<UL>
	<LI><P CLASS="western">C/C++ program allows versions for Microsoft
	Windows in addition to Linux and other POSIX operating systems</P>
	<LI><P CLASS="western">Allows a single autochanger to simultaneously
	utilize multiple directories/mountpoints for its virtual slots,
	emulating a multiple-magazine, multiple-drive autochanger.</P>
	<LI><P CLASS="western">Cleanly handles the situation where a
	removable disk drive, after having been previously unmounted with
	one or more of its slots still &ldquo;loaded&rdquo; into a virtual
	drive, is later re-mounted</P>
	<LI><P CLASS="western">Automatically generates unique volume
	barcodes without an additional barcode definition file</P>
	<LI><P CLASS="western">Uses the barcode volume label as the actual
	filename for a volume file</P>
	<LI><P CLASS="western">Adds the concept of naming autochangers. When
	using multiple autochangers, this can be used to assign &ldquo;magazines&rdquo;
	(removable drives) to a particular autochanger and prevent other
	autochangers from using them.</P>
	<LI><P CLASS="western">Allows assigning a 'magazine' to an
	autochanger by its filesystem UUID.</P>
	<LI><P CLASS="western">Adds an extended API command, <I>initmag</I>,
	to initialize a new magazine.</P>
	<LI><P CLASS="western">Adds an extended API command, <I>listmags</I>,
	to list an autochanger's currently attached magazines.</P>
</UL>
<P CLASS="western">Vchanger <SPAN STYLE="font-style: normal">was
designed to be used with Bacula to utilize removable disk drives as
backup media for a backup solution for small businesses, home
networks, or the subset of Bacula users for whom backing up to
removable disk drives makes practical sense.</SPAN></P>
<P CLASS="western">What follows is a description of vchanger and a
method of utilizing removable drives as the backup media for a backup
solution using vchanger with <A HREF="http://www.bacula.org/">Bacula</A>.</P>
<H3 CLASS="western"><A NAME="copyright"></A>1.1 Copyright And License</H3>
<P CLASS="western">This document, Vchanger<EM> HOWTO</EM>, is
Copyright (c) 2008-2010 by <EM><SPAN STYLE="font-style: normal">Josh
Fisher</SPAN></EM>. Permission is granted to copy, distribute and/or
modify this document under the terms of the GNU Free Documentation
License, Version 1.1 or any later version published by the Free
Software Foundation; with no Invariant Sections, with no Front-Cover
Texts, and with no Back-Cover Texts. A copy of the license is
available at <A HREF="http://www.gnu.org/copyleft/fdl.html" TARGET="_top">http://www.gnu.org/copyleft/fdl.html</A>.
</P>
<H3 CLASS="western"><A NAME="disclaimer"></A>1.2 Disclaimer</H3>
<P CLASS="western">No liability for the contents of this document can
be accepted. Use the concepts, examples and information at your own
risk. There may be errors and inaccuracies which could damage to your
system. Though this is highly unlikely, proceed with caution. The
author(s) do not accept responsibility for your actions.</P>
<P CLASS="western">All copyrights are held by their respective
owners, unless specifically noted otherwise. Use of a term in this
document should not be regarded as affecting the validity of any
trademark or service mark. Naming of particular products or brands
should not be seen as endorsements.</P>
<H3 CLASS="western"><A NAME="credits"></A>1.3 Credits / Contributors</H3>
<P CLASS="western">Many thanks to those who have participated on the
<A HREF="https://lists.sourceforge.net/lists/listinfo/vchanger-users">Vchanger
Users e-mail list</A> with bug reports, testing, and suggestions.</P>
<P CLASS="western">Thanks, also, to all those who frequent the <A HREF="https://lists.sourceforge.net/lists/listinfo/bacula-users">Bacula
User's e-mail list</A>, and of course to Kern Sibbald and the other
<A HREF="http://www.bacula.org/">Bacula</A> developers.</P>
<P CLASS="western">Bacula<SUB><FONT FACE="Times New Roman, serif">&reg;</FONT></SUB>
is a registered trademark of John Walker.</P>
<P CLASS="western">Windows<SUB><FONT FACE="Times New Roman, serif">&reg;</FONT></SUB>
<FONT FACE="Times New Roman, serif">is a registered trademark of
Microsoft Corporation in the United States and other countries.</FONT></P>
<H3 CLASS="western"><A NAME="feedback"></A>1.4 Feedback</H3>
<P CLASS="western"><A HREF="https://lists.sourceforge.net/lists/listinfo/vchanger-users">Vchanger
Users e-mail list</A> hosted by Sourceforge should be used for
feedback. Otherwise, contact information for the author is available
in the source tarball.</P>
<H3 CLASS="western"><A NAME="definitions"></A>2. Definitions</H3>
<P CLASS="western"><I>Bacula</I> is an open source network backup
solution. Much more information about Bacula is available at the
Bacula website <A HREF="http://www.bacula.org/">http://www.bacula.org</A>.</P>
<P CLASS="western">An <I>autochanger</I> is a backup storage device
consisting of one or more tape drives, a mechanical tape library
where a number of tapes are stored, and an individually addressable
robotic device capable of physically moving tapes between the tape
library and the tape drives. The tape library contains mechanical
slots, each of which can hold one tape. In most cases, the slots are
located in one or more mechanical magazines that can be inserted into
and removed from one or more magazine bays.</P>
<P CLASS="western">A <I>virtual autochanger</I> emulates a tape
autochanger using disk storage, rather than tapes. Note that in the
strictest sense, vchanger is not a tape library emulator, in that it
does not implement a device driver with SCSI command interface.
Rather it utilizes an API implemented by Bacula to accept commands
from a Bacula Storage Daemon to load and unload drives, etc.</P>
<P CLASS="western">A <I>magazine</I> is a mechanical tape storage
device having a number of slots into which tapes are inserted. The
tape library of many autochangers consists of one or more removable
magazines, allowing several tapes at a time to be swapped into or out
of the tape library.</P>
<P CLASS="western">A <I>removable disk drive</I> is a random access
disk storage device that is external to, or easily removable from, a
computer system. Examples are external drive enclosures that connect
via USB, Firewire, eSATA, and hot swappable SCSI/SAS/SATA drive bays.</P>
<P CLASS="western">The term <I>hot swappable</I> refers to hardware
devices that may be attached to and removed from a running computer
system.</P>
<H1 CLASS="western"><A NAME="overview"></A>3. Overview</H1>
<P CLASS="western"><SPAN STYLE="font-style: normal">Bacula is already
very proficient at creating backup volumes on disk storage devices.
The Automated Disk Backup section of Bacula's</SPAN> <A HREF="http://www.bacula.org/en/?page=documentation"><SPAN STYLE="font-style: normal">Main
Reference Guide</SPAN></A> <SPAN STYLE="font-style: normal">describes
the use of disk storage with Bacula in great detail. Therefore, in
many cases, it is not necessary or useful to use a disk-based virtual
autochanger. When storing backup volumes on fixed disk, such as when
using a disk-disk-tape backup method, it does not usually make sense
to add the extra complexity. A disk-based virtual autochanger is most
useful when storing backup volumes on removable disk drives that can
be hot swapped.</SPAN></P>
<P CLASS="western" STYLE="font-style: normal">A virtual autochanger
emulates a traditional tape autochanger device, and so some
differences between tape autochangers and disk-based virtual
autochangers are given below.</P>
<TABLE WIDTH=664 BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=146>
	<COL WIDTH=518>
	<TR VALIGN=TOP>
		<TD WIDTH=146>
			<P CLASS="col1-western">Volume</P>
		</TD>
		<TD WIDTH=518>
			<P CLASS="western">In a tape autochanger, a volume is a sequential
			region of data on a tape and usually refers to the entire tape. In
			a disk autochanger, a volume is a file on a disk filesystem.</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=146>
			<P CLASS="col1-western">Slot</P>
		</TD>
		<TD WIDTH=518>
			<P CLASS="western">In a tape autochanger, a slot is the mechanical
			slot in the tape library, (usually in a magazine), in which a tape
			is held when not loaded into a tape drive. In a disk autochanger,
			a slot is an index number that maps to a particular volume file on
			a particular virtual magazine.</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=146>
			<P CLASS="col1-western">Magazine</P>
		</TD>
		<TD WIDTH=518>
			<P CLASS="western">In a tape autochanger, a magazine is a
			mechanical device containing a fixed number of slots that hold
			tapes not currently loaded into a tape drive. In a disk
			autochanger, a magazine is a directory containing a fixed number
			of volume files, one file for each of the magazine's slots.
			Generally, the directory is the mountpoint of a filesystem
			partition of a removable drive.</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=146>
			<P CLASS="col1-western">Magazine Bay</P>
		</TD>
		<TD WIDTH=518>
			<P CLASS="western">In a tape autochanger, a bay is they physical
			location into which a magazine is inserted. In a disk autochanger,
			a bay is an index into an array of the autochanger's currently
			mounted magazines.</P>
		</TD>
	</TR>
</TABLE>
<H1 CLASS="western"><A NAME="implementation"></A>4. Virtual
Autochanger Implementation</H1>
<P CLASS="western"><SPAN STYLE="font-style: normal">vchanger
implements the <A HREF="http://www.bacula.org/5.0.x-manuals/en/main/main/Autochanger_Resource.html#SECTION0032130000000000000000">Bacula
Autochanger Interface</A></SPAN> <SPAN STYLE="font-style: normal">API,
which defines the following commands:</SPAN></P>
<TABLE WIDTH=664 BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=132>
	<COL WIDTH=532>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">list</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">Lists the barcodes of the volumes in each slot</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">load</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">Loads a volume from a slot into a drive</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">unload</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">Unloads a volume from a drive and moves it back
			into a slot</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">slots</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">Returns the number of slots in the autochanger</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">loaded</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">Returns the one-based slot number that the
			volume currently loaded into a drive came from, or zero if the
			drive is empty</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western" STYLE="font-style: normal">vchanger also
implements two extended commands that are not part of the Bacula
Autochanger Interface API:</P>
<TABLE WIDTH=664 BORDER=0 CELLPADDING=0 CELLSPACING=0 STYLE="page-break-before: auto; page-break-after: auto">
	<COL WIDTH=132>
	<COL WIDTH=532>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">initmag</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">Initialize a directory/mountpoint as a new
			magazine for a virtual autochanger</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">listmags</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">List the magazines currently attached to a
			virtual autochanger</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western"><SPAN STYLE="font-style: normal">For autochanger
devices, the Bacula Storage Daemon calls an external autochanger
script or program to perform functions such as loading a tape into a
drive, unloading a tape, etc. Bacula relies on the autochanger script
or program to handle the details of manipulating the autochanger's
robotic tape library mechanism. Vchanger is one such program, and is
invoked by the Bacula Storage Daemon with 5 positional parameters
defined as:</SPAN></P>
<TABLE WIDTH=664 BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=132>
	<COL WIDTH=532>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">Param 1</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western"><FONT FACE="Times New Roman, serif"><FONT SIZE=3><SPAN STYLE="font-style: normal">Path
			given by the </SPAN></FONT></FONT><FONT FACE="Times New Roman, serif"><FONT SIZE=3><I>Changer
			Device</I></FONT></FONT> <FONT FACE="Times New Roman, serif"><FONT SIZE=3><SPAN STYLE="font-style: normal">directive
			in the </SPAN></FONT></FONT><FONT FACE="Times New Roman, serif"><FONT SIZE=3><I>Autochanger</I></FONT></FONT>
			<FONT FACE="Times New Roman, serif"><FONT SIZE=3><SPAN STYLE="font-style: normal">resource.
			For vchanger, this should define the path to the <A HREF="#vchanger_config">autochanger
			configuration</A></SPAN></FONT></FONT> <FONT FACE="Times New Roman, serif"><FONT SIZE=3><SPAN STYLE="font-style: normal">file.</SPAN></FONT></FONT></P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">Param 2</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">API command to execute</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">Param 3</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">The one-based slot number the API command is to
			act upon</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">Param 4</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">Path given by the <I>Archive Device</I>
			directive of the <I>Device</I> resource corresponding to the drive
			number given in parameter 5 (ignored by vchanger)</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=132>
			<P CLASS="col1-western">Param 5</P>
		</TD>
		<TD WIDTH=532>
			<P CLASS="western">The zero-based drive number the API command is
			to act upon</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western">Vchanger requires a unique work directory for each
defined autochanger. Each autochanger is assigned a unique name
defined in its configuration file. By default, an autochanger's work
directory is created as a subdirectory of the Bacula work directory
(usually /var/lib/bacula) with the same name as the autochanger.
Since vchanger will be called by the Bacula Storage Daemon, the
autochanger's work directory <FONT SIZE=3 STYLE="font-size: 13pt"><B>must
have permissions set</B></FONT> to allow read/write access for the
user/group that the Bacula Storage Daemon runs as.</P>
<P CLASS="western">An autochanger's work directory is where vchanger
will create symlinks to the directories/mountpoints that are acting
as virtual magazines. State information is also kept in the
autochanger's work directory in files named 'stateN', where N is the
virtual drive number. The stateN files keep track of the volume last
loaded into drive N. State information for each of the autochanger's
magazine bays are kept in files named 'bayN', where N is the bay
number. Additionally, there is a file named 'nextmag' that keeps
track of the next available magazine number and is only used when
initializing a new magazine using the <I>initmag</I> extended API
command.</P>
<H3 CLASS="western"><A NAME="disk-changerDifferences"></A>4.1.
Differences Between vchanger and disk-changer</H3>
<P CLASS="western">The disk-changer script that comes with Bacula
implements a disk autochanger by dynamically creating a symlink to
the volume file that is &ldquo;loaded&rdquo; into a virtual drive.
The Bacula Storage Daemon device is configured with a fixed device
name. In the case of StorageType=File, that device name is the path
name of a regular file. By configuring the Storage Daemon device name
with the path to a symlink, rather than a regular file, the
disk-changer script can be used to create or alter the symlink to
point to the volume file corresponding to the selected slot.</P>
<P CLASS="western">Vchanger takes a different approach. Instead of
the symlink pointing to the loaded volume file, vchanger creates the
symlink pointing to the directory that contains the loaded volume
file. The filename of the loaded volume is always &ldquo;driveN&rdquo;,
where N is the virtual drive that the volume file is loaded into.
Vchanger &ldquo;loads&rdquo; a volume file into virtual drive N by
creating a symlink to point to the magazine directory, then renaming
the volume file for the selected slot to 'driveN' and storing the
original volume name in a file named 'loadedN'. An unload renames the
driveN file back to it's original volume file name, clears the
loadedN file, and deletes the symlink. One advantage of this method
is that it allows vchanger to be built for versions of Windows prior
to Vista/Server 2008 which do not implement file symlinks, but do
implement directory symlinks. Another advantage is that any virtual
drive can be loaded from any one of multiple virtual magazines.</P>
<H3 CLASS="western"><A NAME="virtual_magazines"></A>4.2. Virtual
Magazines</H3>
<P CLASS="western">A virtual autochanger magazine is a directory,
usually the mountpoint for a filesystem partition on a removable disk
drive. The magazine directory contains a file named 'index', the
contents of which identify the magazine with a single text string of
the form 'changename_mmmm', where 'changername' is the name of the
virtual autochanger the magazine is assigned to, and 'mmmm' is the 4
digit one-based magazine number assigned to the magazine when it was
initialized with the <A HREF="#command_initmag"><I>initmag</I></A>
command. Every magazine belonging to a particular autochanger must be
assigned a unique magazine number. Together with a unique name for
each autochanger, this forces automatically generated volume names to
be unique. This allows for the use of multiple simultaneous
autochangers and autochangers with multiple magazine bays.</P>
<P CLASS="western">In addition to the index file, every magazine
contains a fixed number of volume files, one for each magazine slot
number. The number of slots (and corresponding volume files) per
magazine is defined by the <I>slots_per_magazine</I> directive in the
autochanger's configuration file, and every magazine initialized for
a particular autochanger has the same number of slots. Each volume
file is named using the form 'changername_mmmm_ssss', where
'changername' and 'mmmm' are the autochanger's name and the magazine
number (as described above), and 'ssss' is the one-based magazine
slot number.</P>
<P CLASS="western">The volume filenames are also used as the
&ldquo;barcode&rdquo; labels for the volumes, emulating the barcode
reader functionality found in many tape autochangers. This allows
Bacula's barcode support to automate the labeling of the
autochanger's volumes. Bacula creates a backup volume on each of
these volume files in much the same way that it creates a backup
volume on a tape, including writing a Bacula volume label at the
beginning of the volume file and writing sequential blocks of data
following the volume label.</P>
<P CLASS="western">Additionally, a file named &ldquo;loadedN&rdquo;,
where N is a virtual drive number, is created for each virtual drive.
The loadedN files contain the filename of the volume file currently
loaded into virtual drive N. Keeping the magazine state in this way
allows magazine partitions to be unmounted without having to first
unload virtual drives. Using the magazine state information located
on the magazine together with the virtual drive state information
stored in the autochanger's work directory, vchanger can keep the
autochanger in a working state as magazines are swapped in and out.</P>
<P CLASS="western">When using removable drives as magazines, it
should be noted that a <I>load</I> command will fail if the magazine
containing the volume file that Bacula wishes to be loaded is
unavailable, as is the case when a removable drive has been detached
from the system. As with a real (tape) autochanger, an <I>update
slots</I> command must be issued in the Bacula console whenever a
magazine is attached or detached to keep Bacula in synch with the
autochanger. Otherwise, Bacula will have no way to know which slots
contain available volumes and which do not.</P>
<H3 CLASS="western"><A NAME="assigning_magazines"></A>4.3. Assigning
Magazines to an Autochanger</H3>
<P CLASS="western">Magazines are assigned to an autochanger by
placing one or more <I>magazine</I> directives in the autochanger's
configuration file, creating a list of magazines available for use.
An autochanger has one or more magazine &ldquo;bays&rdquo;. The
number of magazine bays is defined by the <I>magazine_bays</I>
directive. If not specified, the autochanger will by default have one
bay. Each magazine bay may have one magazine &ldquo;inserted&rdquo;
into it. Each of the autochanger's magazines have the same number of
slots, defined by the <I>slots_per_magazine</I> directive. The total
number of slots an autochanger has is the number of slots per
magazine times the number of magazine bays. For example, if
<I>magazine_bays</I> = 2 and <I>slots_per_magazine</I> = 3, then the
autochanger will have 6 slots. Virtual slots 1 - 3 will map to
magazine slots 1 &ndash; 3 of the magazine in bay 1 and virtual slots
4 &ndash; 6 will map to magazine slots 1 &ndash; 3 of the magazine in
bay 2.</P>
<P CLASS="western">Vchanger decides which magazine is inserted in
which bay in the following way. The magazines assigned to the
autochanger are examined in the order their corresponding <I>magazine</I>
line appears in the configuration file. The first magazine that is
found to be mounted is considered &ldquo;inserted&rdquo; in bay 1,
the second mounted magazine is considered to be inserted in bay 2,
etc. Unmounted or inaccessible magazines are ignored. Once a magazine
has been assigned to a bay, state information is kept in the
autochanger's work directory, and magazines remain in their assigned
bays until the magazine is physically detached from the system.</P>
<P CLASS="western">A magazine may be specified either as a path to a
directory or as the UUID of a filesystem partition. When specified as
a directory path, the magazine is considered mounted if the directory
exists. A magazine may also be specified by UUID by prefixing the
magazine's filesystem UUID with the string &ldquo;UUID:&rdquo;.
Assigning magazines to the autochanger by UUID is most useful when
using removable (USB, Firewire, eSATA) drives that are assigned
device nodes dynamically by the OS. When specified as a UUID,
vchanger will query the operating system to determine the mountpoint
path of the block device containing a filesystem with that UUID. Note
that vchanger makes no attempt to mount a magazine's partition, as it
generally will not be run as root. It simply identifies the
mountpoint of a magazine partition that is already mounted. <A HREF="#mounting">Section
7</A> describes methods of getting the magazine partitions mounted.</P>
<H3 CLASS="western"><A NAME="multi-magazine"></A>4.4. Multi-magazine
Autochangers</H3>
<P CLASS="western">Multiple magazine bays may be defined by
specifying a value greater than one for the <I>magazine_bays</I>
directive. Because a virtual drive can be loaded from any slot on any
of its attached magazines, a vchanger autochanger is easily scaled.
There are, however, some caveats to be aware of. It is possible to
have empty magazine bays when less than <I>magazine_bays</I>
magazines are currently mounted. In this case, a <I>load</I> from a
slot mapped to a magazine bay that has an &ldquo;inserted&rdquo;
magazine will succeed, but a <I>load</I> from a slot mapped to a
magazine bay that does not have a magazine inserted will fail, and
subsequently cause the Bacula job to fail<SPAN STYLE="font-style: normal">.
It is possible to run a multi-magazine autochanger without magazines
in some of its magazine bays as long as Bacula is always kept
informed of which slots contain available volumes by issuing the
'update slots' command from bconsole whenever magazines are attached
or detached.</SPAN></P>
<H3 CLASS="western"><A NAME="synch_bacula"></A>4.5. Keeping Bacula In
Synch With an Autochanger</H3>
<P CLASS="western"><SPAN STYLE="font-style: normal">Whenever a
magazine partition is mounted or unmounted, as for example when
attaching or detaching a removable drive, an autochanger will have a
different set of volume files in its slots. Bacula keeps track of
which slots hold which volumes, so hot-swapping removable drives will
cause the autochanger to be out of synch with Bacula. For this
reason, Bacula provides the </SPAN><I>update slots </I><SPAN STYLE="font-style: normal">command,
which can be issued in bconsole. The </SPAN><I>update slots</I>
<SPAN STYLE="font-style: normal">command causes Bacula to query the
autochanger to determine the available volumes and update its idea of
which volume is in each of the autochanger's slots. Just like a real
(tape) autoloader, whenever any magazine is attached or detached the
</SPAN><I>update slots</I> <SPAN STYLE="font-style: normal">command
must be issued in bconsole to keep Bacula in synch with the
autochanger.</SPAN></P>
<H1 CLASS="western"><A NAME="install"></A>5. Installing vchanger</H1>
<P CLASS="western">On most POSIX systems, vchanger can be compiled
and installed from source as follows.</P>
<P CLASS="western">Unpack the gzip compressed tar archive.</P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.2in">[]$ tar -xzf vcahnger-0.8.3.tar.gz</PRE><P CLASS="western" STYLE="margin-top: 0.08in">
Configure the build system and compile vchanger</P>
<PRE CLASS="western">[]$ cd vchanger
[]$ ./configure
[]$ make</PRE><P CLASS="western" STYLE="margin-top: 0.08in">
As root, install the executable and documentation</P>
<PRE CLASS="western">[]$ su root
[]# make install-strip</PRE><P CLASS="western" STYLE="margin-top: 0.08in">
This will install the vchanger executable in /usr/local/bin and the
documentation in /usr/local/share/doc/vchanger.</P>
<H3 CLASS="western"><A NAME="install_win32"></A>5.1. Installing the
Windows Version of vchanger</H3>
<P CLASS="western">vchanger requires at least Windows XP or Windows
Server 2003 and will not run on earlier versions of Windows. A
Windows installer is available for downloading from SourceForge that
will install a 32-bit x86 version of vchanger. A 64-bit x86_64
version of vchanger is not yet available. The 32-bit version may work
on 64-bit versions of Windows, but this has not yet been tested.</P>
<H3 CLASS="western"><A NAME="win32_build"></A>5.1.1. Installing the
Windows Version from Source</H3>
<P CLASS="western">The Windows version was developed under <A HREF="http://fedoraproject.org/">Fedora</A>
11 Linux using the <A HREF="http://www.mingw.org/">MinGW</A>
(gcc-4.4.0) cross-compiler system. On a Linux system with MinGW
development tools installed, the Windows version can be built as
follows:</P>
<P CLASS="western">Unpack the gzip compressed tar archive in your
home directory.</P>
<PRE CLASS="western">[]$ cd ~
[]$ tar -xzf /path/to/vcahnger-0.8.3.tar.gz</PRE><P CLASS="western" STYLE="margin-top: 0.08in">
Configure the build system and cross-compile vchanger</P>
<PRE CLASS="western">[]$ cd vchanger
[]$ ./configure --host=i686-pc-mingw32 --enable-win32 \
[]$ --prefix=/home/your-username/vchanger/win32
[]$ make -k all
[]$ make install-strip</PRE><P CLASS="western" STYLE="margin-top: 0.08in">
The win32 executable, vchanger.exe, will be in ~/vchanger/win32/bin
and the Windows version documentation in
~/vchanger/win32/share/doc/vchanger.</P>
<P CLASS="western">The win32 version of vchanger can be built on a
Windows system using MinGW and <A HREF="http://www.mingw.org/">MSYS</A>.
Setup a MSYS home directory, for example
C:\MSYS\1.0\home\your-username, assuming a standard installation of
MSYS. Unpack the vchanger source tarball in
C:\MSYS\1.0\home\your-username, then start up a MSYS console window
and perform the following.</P>
<PRE CLASS="western">$ cd /home/your-username/vchanger
$ ./configure --enable-win32 --prefix=/home/your-username/vchanger/win32
$ make -k all
$ make install-strip
$ exit</PRE><P CLASS="western">
The win32 executable, vchanger.exe, will be in
C:\MSYS\1.0\home\your-username\vchanger\win32\bin and the Windows
version documentation will be in
C:\MSYS\1.0\home\your-username\vchanger\win32\share\doc\vchanger. 
</P>
<P CLASS="western">After building vchanger, move the vchanger.exe
executable and the contents of the share/doc/vchanger directory to an
installation directory. The Windows installer installs the files to a
subdirectory named vchanger in the standard 'Program Files'
directory. 
</P>
<H1 CLASS="western"><A NAME="preparing"></A>6. Preparing Removable
Drives</H1>
<H3 CLASS="western"><A NAME="preparing_linux"></A>6.1. Preparing
Drives For Linux</H3>
<P CLASS="western">Preparing the removable drives for use on Linux is
fairly straight forward. All that is needed is a filesystem partition
on the removable drive. Most removable drives come with a FAT32 or
NTFS filesystem installed. FAT32 limits the maximum Bacula volume
size that may be used to 4 GB and does not provide for file level
security. Any appropriate filesystem supported by the OS may be used
on the magazine partitions. If using USB drives and relatively small
volume file sizes, then ext2 may be an appropriate file system, while
for a 4 drive SATA drive bay with 4 TB of storage a XFS file system
might be more appropriate. For the examples in this howto, the ext4
file system is used.</P>
<H3 CLASS="western"><A NAME="partition"></A>6.1.1. Partitioning the
Drive</H3>
<P CLASS="western">Since most removable drives come with a FAT32 or
NTFS file system installed, the drive must be repartitioned in order
to create an ext3 file system. To partition a new drive we need to
know the device node that udev assigns to the drive. This can usually
be determined from the output of dmesg a few seconds after the drive
is attached. After determining the drive's device node, say for
example /dev/sdc, use fdisk /dev/sdc (or some other partitioning
tool) to create a single Linux partition as the drive's primary
partition number 1.</P>
<H3 CLASS="western"><A NAME="formatting"></A>6.1.2. Formatting the
Partition Filesystem</H3>
<P CLASS="western">Assuming the drive was assigned node /dev/sdc, the
partition can now be formatted and labeled using:</P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.08in">mke2fs -t ext4 -O large_file /dev/sdc1</PRE><P CLASS="western">
This will create a new ext4 file system on the partition. Now unplug
the drive, wait a few seconds, then plug it back in. After
re-attaching the drive, the name of the symlink in /dev/disk/by-uuid
pointing to the filesystem partition's device node, (/dev/sdc1 in the
example above), will reveal the UUID that can be used in a <I>magazine</I>
directive in a vchanger configuration file to assign the removable
drive to an autochanger. On many systems, the UUID of the filesystem
can also be determined with the blkid command.</P>
<H3 CLASS="western"><A NAME="mag_permissions"></A>6.1.3. Setting
Permissions for the Partition Filesystem</H3>
<P CLASS="western">The Bacula Storage Daemon does not usually run as
root. Since vchanger will be invoked by the Storage Daemon, and so
will run as the same user it does, permissions for the magazine's
mounted filesystem must be set to allow write access to the user that
the Storage Daemon runs as. This can be done by mounting the new
partition somewhere, then using chown and chmod to set the
appropriate permissions to allow write access for the user that the
Storage Daemon runs as.</P>
<H3 CLASS="western"><A NAME="preparing_win32"></A>6.2. Preparing
Drives For Windows</H3>
<P CLASS="western">Preparing the removable drives for use with
Windows is simple. Since most removable drives come with a single
large partition having a FAT32 or NTFS file system, they can usually
be used as shipped.</P>
<P CLASS="western">It is possible to use the NTFS file system with
removable drives. In fact, it is possible to use any file system for
which there is a read/write installable file system driver, (such as
the <A HREF="http://www.fs-driver.org/index.html">ext2 Installable
File System for Windows</A>). With NTFS, however, the default write
caching may lead to file system corruption if the volume is not
properly unmounted before detaching it, making it unsafe to simply
unplug a removable drive containing a NTFS file system. If using the
NTFS file system, ensure that write caching is turned off. For
example purposes, the FAT32 file system will be used on Windows,
despite its 4 GB file size limit</P>
<H3 CLASS="western">6.2.1. Determining a Magazine Partition's UUID</H3>
<P CLASS="western">On Windows, a filesystem UUID is known as a Volume
Serial Number, (not to be confused with the manufacturer's hardware
serial number). Volume Serial Numbers, are 8 hex digits with a '-'
between the first 4 and last 4 hex digits. This format differs from
the UUIDs used by most POSIX systems, and is due to Windows storing
the Volume Serial Number internally as a 32-bit binary number. This
is not a problem, however, as Linux (and probably most other POSIX
systems) will happily use the Windows Volume Serial Number as the
filesystem UUID, though it is shorter in length.</P>
<P CLASS="western">The Volume Serial Number is what will be used as
the UUID when specifying <I>magazine</I> directives in an
autochanger's configuration file. The simplest way to get the Volume
Serial Number is to open a Command Prompt window and issue a DIR
command on the removable drive's drive letter.</P>
<H1 CLASS="western"><A NAME="mounting"></A>7. Mounting Removable Disk
Drives</H1>
<P CLASS="western">On Linux and other modern POSIX systems, removable
drives are assigned a device node when they are plugged in, but the
OS does not by default mount the drive partitions. Auto-mounting is
often handled by, for example, <A HREF="http://www.gnome.org/">Gnome</A>
<A HREF="http://www.gnome.org/projects/nautilus/index.html">Nautilus</A>,
but this will not suffice for use with daemons, such as the Bacula
Storage Daemon that will normally invoke vchanger. The block storage
device containing the magazine's filesystem partition must, by some
means, be mounted before it can be used by vchanger.</P>
<H3 CLASS="western">7.1. udev and Hot-swappable Drives</H3>
<P CLASS="western"><A HREF="http://www.kernel.org/pub/linux/utils/kernel/hotplug/udev.html">Udev</A>
is the subsystem that dynamically assigns device nodes to hot
swappable hardware devices when they are attached to a running system
and frees those device nodes when they are detached. There is no
guarantee that a particular piece of hardware will be assigned a
known device node when it is plugged in. The device node that udev
assigns will depend on how many other devices are already attached
and could change every time the hot-swappable device is plugged in.</P>
<P CLASS="western">Fortunately, udev provides a way to create aliases
to the device nodes it assigns so that the device can be accessed
using the fixed alias, regardless of the actual device node assigned.
With most Linux distributions, the aliases are symlinks created
dynamically by udev in subdirectories of /dev/disk, and these
symlinks point to the actual device node assigned to the block
storage device. In particular, symlinks are created under
/dev/disk/by-uuid such that the symlink name is the UUID of the
partition's filesystem. Consider, for example, a USB removable drive
with a partition containing a ext3 filesystem with UUID
9667f83c-6150-44c7-b0d4-57564f174b35. When this USB drive is
attached, udev will assign a device node to it's partition and create
the symlink /dev/disk/by-uuid/9667f83c-6150-44c7-b0d4-57564f174b35
pointing to the actual device node assigned. The device can then be
accessed using the known 'by-uuid' alias without having to discover
the actual device node. 
</P>
<H3 CLASS="western"><A NAME="manual_mounting"></A>7.2. Manually
Mounting Removable Drive Partitions</H3>
<P CLASS="western">One way to handle mounting and unmounting of
removable drive partitions is for the operator to manually mount the
partitions when the removable drive is attached and manually unmount
the partitions before they are detached. With device aliases in
/dev/disk/by-uuid, this is a simple task, since the UUID of the
magazine partition's filesystem is known. The mountpoint path name
really doesn't matter when specifying manually mounted magazines by
UUID, as vchanger will discover the mountpoint automatically.</P>
<P CLASS="western">It is also possible, when manually mounting
magazine partitions, to use the mountpoint path in the magazine
directive, rather than the UUID. When a magazine is specified by path
(rather than by UUID), vchanger assumes the magazine is mounted if
the path exists.</P>
<H3 CLASS="western"><A NAME="autofs"></A>7.3. Using autofs To Mount
Removable Drive Partitions</H3>
<P CLASS="western">The <A HREF="http://www.autofs.org/">autofs</A>
daemon provides a way to mount and unmount the magazine partitions
on-the-fly as they are accessed. This eliminates the need for manual
mounting of the magazine partitions and makes swapping magazines a
nearly plug-n-play operation. An automount map file for use with
vchanger is given below.</P>
<PRE CLASS="western"># /etc/auto.vchanger
*          -fstype=auto,rw,sync       :/dev/disk/by-uuid/&amp;
# eof</PRE><P CLASS="western">
Notice that 'sync' is specified in the flags that autofs will pass to
the mount command. This will turn off write caching and force all
writes to the magazine's filesystem to be written immediately to
disk. Though it reduces write performance, it helps to reduce the
chance of data loss when a removable drive is detached following a
backup. Much better write performance can be had by not specifying
the sync option and being extra careful not to unplug removable
drives until after autofs unmounts them.</P>
<P CLASS="western">A line is then added to the /etc/auto.master file
to tell autofs to pull in the new auto.vchanger configuration:</P>
<PRE CLASS="western"># /etc/auto.master
# ...
/mnt/vchanger      /etc/auto.vchanger        --timeout=30
# eof</PRE><P CLASS="western">
After restarting the autofs daemon, whenever a file or directory with
a full path beginning with '/mnt/vchanger' is accessed, the autofs
filesystem will search the map defined in the /etc/auto.vchanger file
for a key matching the path being accessed. In this case, the only
key in /etc/auto.vchanger is the wildcard '*', meaning any path name
beginning with '/mnt/vchanger' will match. Autofs then automatically
mounts the device mapped to the wildcard key at the path being
accessed. The /etc/auto.vchanger map file specifies the device to be
mounted as /dev/disk/by-uuid/&amp;. The '&amp;' is substituted for
the key value. For example, when a program attempts to access
/mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35
(or any files or directories below it), the autofs daemon will look
at the auto.vchanger map for the key
9667f83c-6150-44c7-b0d4-57564f174b35 and discover that it should
mount /dev/disk/by-uuid/9667f83c-6150-44c7-b0d4-57564f174b35 at
/mnt/vchanger/9667f83c-6150-44c7-b0d4-57564f174b35 with mount options
'-fstype=auto,rw,sync'. After a period of 30 seconds of no activity,
autofs will automatically unmount the device.</SPAN></P>
<P CLASS="western" STYLE="font-style: normal">Always make sure autofs
is working properly before continuing with setting up vchanger. If
using the above autofs config files, when you plug in a USB drive
with filesystem UUID of, say, 9667f83c-6150-44c7-b0d4-57564f174b35,
you should be able to list its contents with the command</P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.2in"># ls /mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN></PRE><P CLASS="western" STYLE="font-style: normal">
The ls command should trigger an automatic mount of the partition.
Then after waiting for the timeout period, the drive should
automatically be unmounted.</P>
<H3 CLASS="western"><A NAME="with_autofs"></A>7.3.1. Configuring
vchanger For Use With autofs</H3>
<P CLASS="western">When using <A HREF="http://www.autofs.org/">autofs</A>
to automount magazine drives, the magazines will be mounted only when
they are in use. However, when magazine's are assigned by UUID,
vchanger cannot determine their mountpoints until after they are
mounted. To solve this problem, the <I>automount_dir</I> directive in
the vchanger configuration file can be set to specify the directory
under which autofs mounts the magazines. If <I>automount dir</I> is
non-blank, then when vchanger is invoked it will attempt to access
{<I>automount_dir</I>}/{<I>UUID</I>} for each magazine assigned by
UUID. This access will trigger autofs to mount the magazine, allowing
vchanger to determine that the magazine is attached and which
magazine bay it is &ldquo;inserted&rdquo; into. In the example map
above, autofs mounts magazine partitions under /mnt/vchanger, so the
autochanger's configuration file must contain the line 'automount_dir
= /mnt/vchanger' so that vchanger can determine which of its assigned
magazines are being used. The <I>automount_dir</I> directive is only
needed when using autofs to mount magazines specified by UUID.</P>
<H3 CLASS="western"><A NAME="mounting_win32"></A>7.4. Mounting
Removable Drives On Windows</H3>
<P CLASS="western">Microsoft Windows operating systems normally
auto-mount removable drive partitions with recognized file systems.
By default, the mount point for a partition will be a drive letter
(ie. E:). Unlike POSIX operating systems, where '/' is the root of
the single directory tree, Windows operating systems use a multi-root
directory structure where drive letters (and network UNC base names)
represent the roots of multiple distinct directory trees. When a
removable drive is plugged in for the first time, assuming the drive
has a single partition, its partition will be mounted at the next
available drive letter. Windows remembers the drive letter assignment
for a partition so that it will be mounted at the same drive letter
when it is later re-attached, unless the drive letter is already
being used for another partition, in which case it will be mounted at
the next available drive letter. Note that it is not possible to
assign the same drive letter to two different removable drives
simultaneously.</P>
<P CLASS="western">It is also possible, however, to mount a volume at
a (empty) subdirectory in another directory tree, as long as the
volume mounted at the root of that other directory tree is a NTFS
volume. In fact, only the volume from which Windows boots and volumes
containing a virtual memory storage file even require a drive letter
at all. For removable drives, the drive letter assignment can be
deleted altogether and the partition always auto-mounted at a
directory in an NTFS directory tree. It should be noted that only the
mount point directory must be on an NTFS volume. The partition being
mounted may have a FAT32 file system or any other file system for
which there is a file system driver installed. See &ldquo;<A HREF="http://support.microsoft.com/kb/307889">How
to create and use NTFS mounted drives in Windows XP and in Windows
Server 2003</A>&rdquo; for instructions on assigning mount points for
removable drive partitions. Like with drive letters, it is not
possible to assign the same mountpoint to more than one drive.</P>
<P CLASS="western">On Windows, magazine partitions should always be
specified by UUID (Volume Serial Number). This ensures that vchanger
will be able to find the partition's mountpoint without prior
knowledge of which drive letter or mountpoint Windows has currently
assigned to the drive.</P>
<H1 CLASS="western"><A NAME="vchanger_config"></A>8. Configuring
vchanger</H1>
<P CLASS="western">Each vchanger autochanger is defined by a
configuration file. Multiple autochangers may be defined as long as
each is given a unique name, its own unique work directory, and its
own unique configuration file. By default, vchanger configuration
files are placed in the Bacula configuration directory (/etc/bacula).
The configuration files <B>must be given permissions</B> that allow
the user the Bacula Storage Daemon runs as to have read access.</P>
<P CLASS="western" STYLE="font-style: normal">A vchanger
configuration file consists of keyword = value pairs. Comments are
defined by a '#' character, and cause text from the '#' until the
next newline character to be ignored. Values including whitespace or
special characters must be enclosed in single or double quotes.
Special characters, including the quote character, appearing inside
of the quoted value must be escaped by prepending with a '\'
character. The following keywords are defined for an autochanger
configuration file:</P>
<TABLE WIDTH=664 BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=172>
	<COL WIDTH=492>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">changer_name</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">[Required] The unique name of the autochanger.
			This name will also be used to identify magazines belonging to
			this autochanger and will be prepended to all volume barcode
			labels for this autochanger. <BR>Default: none</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">state_dir</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">[Deprecated] Synonym for 'work_dir'</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">work_dir</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">The directory where virtual drive state
			information and symlinks will be created. <BR>Default:
			/var/lib/bacula/&lt;changer_name&gt;</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">logfile</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">The path to a file where vchanger will write
			log and debug messages. This file must be writable by the user the
			Bacula Storage Daemon runs as. If specified as a relative path,
			then it is relative to the <I>work_dir</I> directory.<BR>Default:
			none (logging disabled)</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">log_level</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">The level of detail to log to the logfile. The
			value is a string, which may be 'LOG_EMERG', 'LOG_CRIT',
			'LOG_ERR', etc. as defined for the syslog() system call. See man 2
			syslog for possible values.<BR>Default: 'LOG_ERR'</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">slots_per_magazine</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">The fixed number of volume slots each magazine
			has<BR>Default: 10</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">virtual_drives</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">The number of virtual drives this autochanger
			has. Multiple virtual drives allow Bacula to concurrently access
			multiple volumes. The number of virtual drives to use must be less
			than or equal to the <I>slots_per_magazine</I> <SPAN STYLE="font-style: normal">value</SPAN>.<BR>Default:
			1</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">magazine</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">[Required] Defines either the path to a
			directory or the UUID of a filesystem partition prepended by the
			string &ldquo;UUID:&rdquo;. The magazine directive assigns a
			directory or partition to this autochanger. This directive may
			appear multiple times to assign multiple magazines.<BR>Default:
			none</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">magazine_bays</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">Defines the number of magazines that vchanger
			expects to be simultaneously mounted. The list of assigned
			magazines given by <I>magazine</I> directives is searched, and the
			first <I>magazine_bays</I> magazines that are mounted will be
			used.<BR>Default: 1</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=172>
			<P CLASS="col1-western">automount_dir</P>
		</TD>
		<TD WIDTH=492>
			<P CLASS="western">The directory under which autofs is configured
			to mount partitions by filesystem UUID. The mountpoint for
			magazines specified by UUID is queried from the system. For
			magazines mounted by autofs, the mountpoint cannot be determined
			automatically when the magazine is not currently mounted. When
			<I>automount_dir</I> is non-blank, vchanger will attempt to cause
			autofs to mount the magazine prior to querying its mountpoint by
			performing a stat on the pathname {<I>automount_dir</I>}/{uuid}.
			When <I>automount_dir</I> is blank no stat is performed and
			magazines must be manually mounted. This directive is ignored on
			Windows systems. <BR>Default: blank</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western"><BR><BR>
</P>
<H1 CLASS="western"><A NAME="initialize"></A>9. Initializing New
Magazines</H1>
<P CLASS="western">After a removable drive has been <A HREF="#preparing">prepared</A>,
it must be initialized for use with vchanger. Initializing consists
of creating a file named 'index', a volume file for each magazine
slot, and a loadedN file for each virtual drive N. The index file
contains a single text string of the form &ldquo;changername_mmmm&rdquo;,
where 'changername' is the name of the autochanger the magazine will
be used with, and 'mmmm' is the 4-digit one-based magazine number
assigned to the magazine. All magazines used with an autochanger must
have a unique magazine number to ensure volume barcodes are unique.
An empty file named 'loadedN' is created for each virtual drive,
where N is the drive number. An empty volume file is created for each
of the magazine's slots. The number of slots in each magazine is
determined by the <I>slots_per_magazine</I> directive in the
autochanger configuration file. The volume files are named
&ldquo;changername_mmmm_ssss&rdquo;, where 'changername' and 'mmmm'
are the autochanger name and unique magazine number, (as described
above), and 'ssss' is the 4-digit one-based slot number of the
magazine slot where the volume is &ldquo;located&rdquo;.</P>
<P CLASS="western">vchanger implements an extended API command,
<I>initmag</I>, that makes initializing new magazines easier. The
following (invoked as root) initializes a new magazine for an
autochanger with configuration file /etc/bacula/c1.conf:</P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.08in">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf initmag 1</PRE><P CLASS="western">
This will assign the next available magazine number to the magazine
in magazine bay 1. A file named 'nextmag' in the autochanger's work
directory keeps track of the next available magazine number for the
autochanger.</P>
<P CLASS="western">The magazine and it's files <B>must be writable</B>
by the user the Bacula Storage Daemon runs as. In the example above,
the -u and -g options set the owner and group of the magazine's files
for a Bacula Storage Daemon that runs as uid=bacula and gid=disk.</P>
<P CLASS="western">The <I>initmag</I> command optionally accepts the
-m flag to manually specify the magazine number to assign to the
magazine. The -m flag is useful for replacing a defective removable
drive and assigning the replacement the same magazine number. It
should be used with caution, however, to prevent magazines from
having duplicate magazine numbers.</P>
<P CLASS="western">If the <I>initmag</I> command fails, then it is
likely that the permissions are not set correctly for the magazine's
filesystem. When the the magazine partition is mounted, the
permissions for its mountpoint should be such that the user the
Storage Daemon runs as (bacula.disk in the above example) has write
access.</P>
<P CLASS="western">In addition to initializing the magazine for use
by an autochanger, it must be assigned to the autochanger before it
will be used. This is done by adding a magazine line to the
autochanger's configuration file. The <I>initmag</I> command does not
currently automatically add the magazine line to the configuration
file.</P>
<H1 CLASS="western"><A NAME="testing"></A>10. Testing vchanger</H1>
<P CLASS="western">vchanger may be tested by running it from the
command line as the user that the Bacula Storage Daemon runs as. For
example purposes, we will assume the Storage Daemon runs as user
'bacula' and group 'disk' and autofs is configured to automount
filesystem partitions by UUID, creating mountpoints under
/mnt/vchanger as described in section <A HREF="#autofs">7.2</A>. We
will use the following autochanger configuration file.</P>
<PRE CLASS="western"># /etc/bacula/c1.conf
changer_name = c1
virtual_drives = 2
slots_per_magazine = 3
magazine_bays = 1
automount_dir = /mnt/vchanger
magazine = UUID:<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN>
magazine = UUID:5039284a<SPAN STYLE="font-style: normal">-4312-57d1-92c4-354710032c79</SPAN>
#eof</PRE><P CLASS="western">
This defines a single-bay autochanger using 3 slots per magazine, 2
virtual drives, 1 magazine bay, and automounting of its magazines.
Two USB hard drives are assigned as valid magazines for this
autochanger. Both drives have been prepared as described in <A HREF="#prepairing">section
6</A>, but neither has been initialized. The <I>automount_dir</I>
directive informs vchanger that autofs is configured to automount the
magazines at mountpoints in the directory /mnt/vchanger, and that it
should attempt to trigger autofs to mount the magazine partitions
prior to querying the system for their mountpoints. With neither of
the drives attached, list the magazine partition currently in use by
invoking (as root):</P>
<PRE CLASS="western">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf listmags
1::-1:</PRE><P CLASS="western">
The output from the <I>listmags</I> command shows that no magazine is
&ldquo;inserted&rdquo; in magazine bay 1, which is correct, since
neither of the two USB drives are attached. The barcodes of the
volumes in each of the autochanger's 3 slots can be viewed with:</P>
<PRE CLASS="western">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf list
1:
2:
3:</PRE><P CLASS="western">
The output from the <I>list</I> command shows that the slots do not
contain barcoded volumes. This is correct, because, again, there is
no magazine (USB drive) attached. Now attach the USB drive containing
the partition with filesystem UUID given by the first <I>magazine</I>
line of the c1.conf file. First, make sure that the magazine, when
mounted, is writable by user bacula.disk.</P>
<PRE CLASS="western">[]# ls -la /mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN>
drwxrwx--- 3 bacula disk 4096 2009-09-17 14:53 .
drwxr-xr-x 3 root   root    0 2009-09-17 14:53 ..</PRE><P CLASS="western">
A <I>listmags</I> command will now show that a magazine is inserted
in bay 1:</P>
<PRE CLASS="western">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf listmags
1::0:/mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN></PRE><P CLASS="western">
Now that the magazine is inserted in bay 1, the bay's state file in
the work directory should show which magazine is inserted:</P>
<PRE CLASS="western">[]# cat /var/lib/bacula/c1/bay1
<SPAN STYLE="font-style: normal">UUID:9667f83c-6150-44c7-b0d4-57564f174b35</SPAN></PRE><P CLASS="western">
The blank changer name field and magazine number of 0 from the above
<I>listmags</I> command show that the USB drive is attached and the
magazine partition is mounted, but it has not been initialized and
assigned to an autochanger. Initialize the magazine with:</P>
<PRE CLASS="western">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf initmag 1
created magazine 1 in bay 1 [/mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN>]</PRE><P CLASS="western">
A <I>listmags</I> command will now show a mounted and initialized
magazine:</P>
<PRE CLASS="western">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf listmags
1:c1:1:/mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN></PRE><P CLASS="western">
And now the <I>list</I> command should show the barcodes of the
volumes in the 3 slots:</P>
<PRE CLASS="western">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf list
1:c1_0001_0001
2:c1_0001_0002
3:c1_0001_0003</PRE><P CLASS="western">
Notice that the barcode labels show the volumes as being in slots
1,2, and 3 of magazine number 1 belonging to autochanger &ldquo;c1&rdquo;.
Now try to load the volume in slot 2 into virtual drive 0 with:</P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.2in">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf load 2 /var/lib/bacula/c1/0/drive0 0</PRE><P CLASS="western">
This command should succeed, and the contents of the <I>work_dir</I>
directory should be:</P>
<PRE CLASS="western">[]# ls -l /var/lib/bacula/c1
lrwxrwxrwx 1 bacula disk   15 Sep 16 00:39 0 -&gt; /mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN>
<SPAN STYLE="font-style: normal">-rw-rw-r-- 1 bacula disk   42 Sep 16 00:39 bay1</SPAN>
-rw-rw---- 1 bacula disk    1 Sep 16 00:34 nextmag
-rw-rw-r-- 1 bacula disk   19 Sep 16 00:39 state0
-rw-rw-r-- 1 bacula disk   19 Sep 16 00:34 state1

[]# ls /var/lib/bacula/c1/0
c1_0001_0001    c1_0001_0003      drive0
index           loaded0           loaded1

[]# cat /mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN>/loaded0
c1_0001_0002

[]# cat /var/lib/bacula/c1/state0
c1_0001_0002</PRE><P CLASS="western">
The symlink /var/lib/bacula/c1/0 <SPAN STYLE="font-style: normal">pointing
to the magazine partition's mountpoint</SPAN> was created, the volume
file 'c1_0001_0002' on the magazine was renamed to 'drive0', and the
loaded volume file's filename was written to the files 'loaded0' on
the magazine and 'state0' in the work directory.</P>
<P CLASS="western">Now load drive 1 from slot 3.</P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.2in">[]# vchanger -u bacula -g disk /etc/bacula/c1.conf load 3 /var/lib/bacula/c1/1/drive1 1</PRE><P CLASS="western">
and the work_dir directory should look like:</P>
<PRE CLASS="western">[]# ls -1 /var/lib/bacula/c1
lrwxrwxrwx 1 bacula disk   15 Sep 16 00:39 0 -&gt; /mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN>
lrwxrwxrwx 1 bacula disk   15 Sep 16 00:42 1 -&gt; /mnt/vchanger/<SPAN STYLE="font-style: normal">9667f83c-6150-44c7-b0d4-57564f174b35</SPAN>
-rw-rw-r-- 1 bacula disk   42 Sep 16 00:39 bay1
-rw-rw---- 1 bacula disk    1 Sep 16 00:34 nextmag
-rw-rw-r-- 1 bacula disk   19 Sep 16 00:39 state0
-rw-rw-r-- 1 bacula disk   19 Sep 16 00:42 state1

[]# ls -1 /var/lib/bacula/c1/0
c1_0001_0001    drive0            drive1
index           loaded0           loaded1

[]# ls -1 /var/lib/bacula/c1/1
c1_0001_0001    drive0            drive1
index           loaded0           loaded1</PRE><P CLASS="western">
Notice that the symlink for drive 0 points to the same magazine
partition mountpoint as the symlink for drive 1. This will always be
the case for a single-magazine autochanger, since there is only one
magazine bay, so only one mounted magazine used at any one time.
However this may or may not be the case for a multi-magazine
autochanger. The virtual drive's symlink points to the mountpoint of
the magazine that contains the volume file loaded into that virtual
drive.</P>
<P CLASS="western">When the USB drive is detached, the listmags
command will once again show that no assigned magazines are mounted,
and the list command will show that the slots contain no barcoded
volumes. Using the same procedure to initialize the second USB drive
will result in it becoming magazine number 2 for autochanger c1, and
its volumes will be named c1_0002_0001, c1_0002_0002, and
c1_0002_0003.</P>
<P CLASS="western">Note that because the <I>magazine_bays</I>
directive has a value of 1 in the above example, the magazine
considered &ldquo;inserted&rdquo; into magazine bay 1 is the last
magazine that was successfully inserted.</P>
<H1 CLASS="western"><A NAME="configuring_bacula"></A>11. Configuring
Bacula To Use The Autochanger</H1>
<P CLASS="western">The virtual autochanger must be defined in Bacula
by adding <I>Autochanger</I> and <I>Device</I> resources to Bacula's
configuration files. 
</P>
<H3 CLASS="western"><A NAME="sd_config"></A>11.1. Configuring the
Bacula Storage Daemon</H3>
<P CLASS="western">To configure the Bacula storage daemon
(bacula-sd), add an <I>Autochanger</I> resource and associated <I>Device</I>
resource(es) to bacula-sd.conf. An example of an autochanger with 2
virtual drives is:</P>
<PRE CLASS="western"># /etc/bacula/bacula-sd.conf
# ...
#----  local virtual autochanger with USB drive &quot;magazines&quot;
Autochanger {
  Name = usb-changer
  Device = usb-changer-drive-0
  Device = usb-changer-drive-1
  Changer Command = &quot;/usr/local/bin/vchanger %c %o %S %a %d&quot;
  Changer Device = &quot;/etc/bacula/c1.conf&quot;
}
#---  drive 0 of the usb-changer autochanger
Device {
  Name = usb-changer-drive-0
  DriveIndex = 0
  Autochanger = yes;
  DeviceType = File
  MediaType = File
  ArchiveDevice = /var/lib/bacula/c1/0/drive0
  RemovableMedia = no;
  RandomAccess = yes;
}
#---  drive 1 of the usb-changer autochanger
Device {
  Name = usb-changer-drive-1
  DriveIndex = 1
  Autochanger = yes;
  DeviceType = File
  MediaType = File
  ArchiveDevice = /var/lib/bacula/c1/1/drive1
  RemovableMedia = no;
  RandomAccess = yes;
}# ...
# eof</PRE><P CLASS="western">
In the <I>Autochanger</I> resource, the <I>Changer Device</I> value
is the path to the vchanger configuration file for this autochanger.
The <I>Changer Command</I> value is the command Bacula will execute
when it needs the autochanger to perform some function, (like loading
a volume). Here, we have installed vchanger in /usr/local/bin, and
bacula is going to pass the <I>Changer Device</I> value (the path to
the vchanger configuration file) in parameter 1, the API command
(load, unload, etc) in parameter 2, the slot number for the command
in parameter 3, the <I>Archive Device</I> value from the <I>Device</I>
resource that has a <I>Drive Index</I> value equal to the drive index
for the command in parameter 4, and the drive index for the command
in parameter 5.</P>
<P CLASS="western">In the <I>Device</I> resource, it is important to
set <I>Device Type</I> = File so that Bacula understands it is
reading/writing a <I>File Storage</I> type volume. The <I>ArchiveDevice</I>
value is the path of the file that Bacula will use as a backup
volume. Notice that <I>ArchiveDevice</I> specifies the path to a file
that Bacula will read/write as a Bacula volume. The path is specified
using the symlink that vchanger creates dynamically in the
autochanger's work directory. For drive 0, <I>/var/lib/bacula/c1/0</I>
is the symlink pointing to the magazine mountpoint, and <I>drive0</I>
is the filename of the volume file. Recall that for the <I>load</I>
command, vchanger will rename the volume file being loaded to driveN,
where N is the virtual drive number.</P>
<H3 CLASS="western"><A NAME="dir_config"></A>11.2. Configuring the
Bacula Director</H3>
<P CLASS="western">The Bacula Director is configured to use the
virtual autochanger as it would be configured for a traditional tape
autochanger.</P>
<PRE CLASS="western"># /etc/bacula/bacula-dir.conf
# ...
# Local USB drive virtual autochanger
Storage {
  Name = c1   # same as 'changer_name' in the vchanger config file
  Address = sd-server-address
  Password = &quot;secret_password&quot;
  Device = usb-changer  # name of the Autochanger resource in bacula-sd.conf
  Media Type = File
  Autochanger = yes;
}
# eof</PRE><H3 CLASS="western">
<A NAME="bacula_interaction"></A>11.3. Bacula / vchanger Interaction</H3>
<P CLASS="western">The Bacula Storage Daemon reads/writes to a volume
file specified by the <I>ArchiveDevice</I> directive in the <I>Device</I>
record. For a vchanger autochanger, <I>ArchiveDevice</I> for the
<I>Device</I> records associated with the autochanger's virtual
drives is specified as WORK_DIR/N/driveN, where N is the numerical
drive number and WORK_DIR is the autochanger's work directory
specified by the work_dir directive in its vchanger configuration
file. In the example above, the Device record associated with
autochanger drive 0 uses ArchiveDevice /var/lib/bacula/c1/0/drive0.
'drive0' is the name of the file the Storage Daemon will read/write,
and it is located in the directory pointed to by the symlink
'/var/lib/bacula/c1/0'. 
</P>
<P CLASS="western">The file 'drive0' is a volume file from one of the
magazine's slots that was renamed to drive0 when a <I>load</I>
command was issued to the autochanger. When the Storage Daemon needs
to read/write a particular volume file, it must first load the volume
file into a virtual drive. The external program or script that the
Storage Daemon calls to perform autochanger loads, unloads, etc. is
specified in the Autochanger resource, and is in this case the
vchanger executable. The Storage daemon may send several commands to
vchanger to query what volume is currently loaded into a drive,
unload a drive, and eventually a <I>load</I> command will be issued
to load the needed volume into one of the autochanger's drives. Using
the above configuration files, for example, and assuming magazine
number 2 is in the autochanger's bay 1, then to write a backup job's
data to the volume in slot 3 of the magazine in bay 1, the following
would happen:</P>
<OL>
	<LI><P CLASS="western">SD issues a <I>loaded</I> command to vchanger
	to determine what volume is currently loaded in drive 0</P>
	<LI><P CLASS="western">If a volume is already loaded in drive 0, SD
	issues an <I>unload</I> command to vchanger to unload the drive.</P>
	<LI><P CLASS="western">SD issues a load command to vcahnger to load
	slot 3 of the magazine in bay 1 into drive 0</P>
	<LI><P CLASS="western">vchanger creates symlink /var/lib/bacula/c1/0
	pointing to the magazine's mountpoint, renames volume file
	c1_0002_0003 on the magazine to drive0, and saves drive and magazine
	state info.</P>
	<LI><P CLASS="western">SD opens the file /var/lib/bacula/c1/0/drive0
	for reading or writing</P>
</OL>
<H1 CLASS="western">12. Using The Autochanger</H1>
<P CLASS="western">After reloading/restarting the Bacula Storage
Daemon and Director to load the new configuration, the Storage device
'c1', (the virtual autochanger that has been created in the examples
above), is ready to use.</P>
<H3 CLASS="western">12.1. Labeling Volumes In New Magazines</H3>
<P CLASS="western">New magazines, such as those created in <A HREF="#initialize">9</A>
above, will have empty volume files. Before these files can be used
as Bacula volumes, Bacula must write a volume label on them. The
easiest way to accomplish this is to use the <I>label barcodes</I>
command from within the Bacula console. Bacula will invoke vchanger
with the <I>list</I> command to extract the barcodes for the volumes
in each autochanger slot, then invoke vchanger with the <I>load</I>
command once for each slot to load the volumes in those slots one at
a time into a virtual drive and write a Bacula volume label to the
volume file using the corresponding barcode to name the volume. The
Bacula volume, barcode, and volume file will all have the same name.</P>
<P CLASS="western">The <I>label barcodes</I> console command should
always be used to label autochanger volumes. The automatic generation
of barcode labels and naming of the volume files that vchanger uses
requires the use of specific volume names. It is possible to use the
<I>label</I> command in the Bacula console to label a volume, but if
a name other than the barcode assigned by vchanger is used it will
cause problems. 
</P>
<H3 CLASS="western">12.2. Inserting Magazines</H3>
<P CLASS="western">To &ldquo;insert&rdquo; a magazine into a magazine
bay of an autochanger, simply attach one of the removable drives
containing a magazine partition assigned to the autochanger, mount
the partition (if not being auto-mounted by autofs), then issue the
<I>update slots</I> command in the Bacula console to keep Bacula
informed of the currently available volumes in each of the
autochanger's slots.</P>
<H3 CLASS="western">12.3. Ejecting Magazines</H3>
<P CLASS="western">To eject a magazine, first check the status of the
director by issuing the <I>status dir</I> in the Bacula console to
make sure no running jobs are currently using one of the
autochanger's volumes. Then unmount and detach the removable drive.
If you are using autofs to automate mounting and unmounting of
drives, then it should only be necessary to simply detach the drive.
However, it is a good idea to allow autofs time to unmount the drive
before simply pulling the plug.</P>
<P CLASS="western">After detaching a removable drive, issue the
<I>update slots</I> command in the Bacula console to keep Bacula
informed of which autochanger slots contain available volumes.
Otherwise, Bacula may attempt to load a volume that is not currently
available, which will result in vchanger returning an error to Bacula
that will cause the job to fail. If you will immediately be inserting
another removable drive to replace the one being ejected, then it is
only necessary to issue the <I>update slots</I> command once after
the replacement drive is inserted.</P>
<P CLASS="western">Note that when selecting a volume from the pool
being used for a backup job, Bacula will favor using the same volume
that was last written to if that volume has status = <I>Append</I>.
In addition to the <I>update slots</I> command, it is usually
necessary to issue an <I>update volume=</I><SPAN STYLE="font-style: normal">
command in bconsole and change the status to </SPAN><I>Used</I><SPAN STYLE="font-style: normal">
for any volumes on the magazine that both have status = </SPAN><I>Append</I><SPAN STYLE="font-style: normal">
and have been written to. Volumes with status = </SPAN><I>Append</I><SPAN STYLE="font-style: normal">
that have not yet been written to will not affect volume selection.
If this is not done, then Bacula will select the volume for the next
job using that pool. Since it is no longer in the changer, Bacula
will ask for it to be mounted again, and this is not likely what is
wanted.</SPAN></P>
<H3 CLASS="western">12.4. Changing Magazines</H3>
<P CLASS="western">When Bacula requests a volume that is not on a
magazine that is currently attached, it will be necessary to &ldquo;insert&rdquo;
the magazine containing the requested volume into the autochanger.
Which magazine to insert will be easily discovered from the volume
label name that Bacula is asking for. As always, after swapping in a
different magazine drive, you must issue the <I>update slots</I>
command in the Bacula console.</P>
<H1 CLASS="western">13. Autochanger Example Configurations</H1>
<P CLASS="western">The below examples assume the use of 250 GB hard
drives and a maximum volume file size of 4,000,000,000 bytes. A
smaller number of volume files could be used by increasing the
maximum volume size, but the maximum volume size must not exceed the
maximum file size allowed by the file system being used.</P>
<H3 CLASS="western">13.1. Single-bay, Single-drive Autochanger</H3>
<P CLASS="western">This configuration is an example of using USB
external drives as magazines. Only a single USB drive is attached at
any one time, and here we specify a single magazine=/mnt/c1 line,
meaning we will be manually mounting the drive at /mnt/c1. A single
virtual drive means that only one volume file at a time can be
read/written. When a magazine is initialized, its volumes are placed
in the Scratch pool. Bacula will move volumes from the Scratch pool
into the other pools when they are needed. When a volume is purged,
it will be moved back into the Scratch pool for later re-use.</P>
<PRE CLASS="western"># /etc/bacula/bacula-sd.conf
# ...
#----  virtual autochanger using USB external drives
Autochanger {
  Name = usb-changer
  Device = usb-changer-drive-0
  Changer Command = &quot;/usr/local/bin/vchanger %c %o %S %a %d&quot;
  Changer Device = &quot;/etc/bacula/c1.conf&quot;
}
#---  drive 0 of the usb-changer autochanger
Device {
  Name = usb-changer-drive-0
  DriveIndex = 0
  Autochanger = yes;
  DeviceType = File
  MediaType = File
  ArchiveDevice = /var/bacula/c1/0/drive0
  RemovableMedia = no;
  RandomAccess = yes;
}
# ...
#eof

# /etc/bacula/bacula-dir.conf
# ...
# Local USB drive virtual autochanger
Storage {
  Name = c1
  Address = sd-server-address
  Password = &quot;secret_password&quot;
  Device = usb-changer
  Media Type = File
  Autochanger = yes;
}
Pool {
  Name = full
  Pool Type = backup
  Storage = c1
  Maximum Volume Bytes = 4gb
  Recycle Pool = Scratch
}
Pool {
  Name = incremental
  Pool Type = backup
  Storage = c1
  Maximum Volume Bytes = 4gb
  Recycle Pool = Scratch
}
Pool {
  Name = Scratch
  Pool Type = backup
}
#...
# eof

# /etc/bacula/c1.conf
# Configuration for vchanger autochanger c1
changer_name = c1
slots_per_magazine = 60
magazine = /mnt/c1
#eof</PRE><H3 CLASS="western">
13.2. Multi-magazine Multi-drive Autochanger</H3>
<P CLASS="western">In this example, a SATA backplane with 4 hot swap
drive bays is being used as a multi-magazine autochanger. The
autochanger will have 200 slots, 50 slots per attached 1 TB SATA
drive with a maximum volume size of 18 GB. 8 SATA drives (magazines)
are assigned to this autochanger, though only 4 will be attached at
any one time, and they are automunted by autofs. Some clients will be
backed up to pool 'group-A' and some will be backed up to pool
'group-B', so two virtual drives are defined, allowing a group-A
client and a group-B client to be backed up concurrently.</P>
<PRE CLASS="western"># /etc/bacula/bacula-sd.conf
# ...
#----  virtual autochanger using 4 drive SATA backplane
Autochanger {
  Name = sata-changer
  Device = sata-changer-drive-0
  Device = sata-changer-drive-1
  Changer Command = &quot;/usr/local/bin/vchanger %c %o %S %a %d&quot;
  Changer Device = &quot;/etc/bacula/c2.conf&quot;
}
#---  drive 0 of the sata-changer autochanger
Device {
  Name = sata-changer-drive-0
  DriveIndex = 0
  Autochanger = yes;
  DeviceType = File
  MediaType = File
  ArchiveDevice = /var/bacula/c2/0/drive0
  RemovableMedia = no;
  RandomAccess = yes;
}
#---  drive 1 of the sata-changer autochanger
Device {
  Name = sata-changer-drive-1
  DriveIndex = 1
  Autochanger = yes;
  DeviceType = File
  MediaType = File
  ArchiveDevice = /var/bacula/c2/1/drive1
  RemovableMedia = no;
  RandomAccess = yes;
}# &hellip;
#eof

# /etc/bacula/bacula-dir.conf
# ...
# Virtual autochanger using 4 drive SATA backplane
Storage {
  Name = c2
  Address = sd-server-address
  Password = &quot;secret_password&quot;
  Device = sata-changer
  Media Type = File
  Autochanger = yes;
}
Pool {
  Name = &ldquo;group-A&rdquo;
  Pool Type = backup
  Storage = c1
  Maximum Volume Bytes = 18gb
  Recycle Pool = Scratch
}
Pool {
  Name = &ldquo;group-B&rdquo;
  Pool Type = backup
  Storage = c1
  Maximum Volume Bytes = 18gb
  Recycle Pool = Scratch
}
Pool {
  Name = Scratch
  Pool Type = backup
}
#...
# eof

# /etc/bacula/c2.conf
# Configuration for vchanger autochanger c2
changer_name = c2
slots_per_magazine = 50
virtual_drives = 2
automount_dir = /mnt/vchanger   # autofs is mounting magazine drives
magazine_bays = 4
magazine = uuid:4733200b-51fc-4778-aa22-fff46a5d594c
magazine = uuid:636151b5-839d-4edd-9ed6-5d89e980920f
magazine = uuid:d243d8e8-1564-4fce-b4be-4584243285c8
magazine = uuid:18b45743-e3fb-4d9b-ad56-ef31f835ce7c
magazine = uuid:4fcb1422-f15c-4d7a-8a32-a4dcc0ef5e00
magazine = uuid:90252fa3-9473-48f6-8bd5-4d8bd1d109fe
magazine = uuid:2e069fc5-8036-4cc6-a849-bb9609a4b724
magazine = uuid:f9de8db4-7ae3-4f6b-a3d4-460b6916bd65
#eof</PRE><H3 CLASS="western">
13.3. Windows Autochangers</H3>
<P CLASS="western">Configuring an autochanger for the Windows version
of vchanger is nearly identical to the Linux example configurations
given above. The differences are that directory paths in the
configuration file use Windows path names, and the Volume Serial
Number of a magazine partition is used as the UUID when assigning
magazines to the autochanger with the <I>magazine</I> directive.</P>
<H1 CLASS="western">Appendix A. vchanger Commands</H1>
<H3 CLASS="western">A.1. list Command</H3>
<P CLASS="western" STYLE="margin-top: 0in; margin-bottom: 0in; font-style: normal">
Bacula issues this command to an autochanger script to list to stdout
the &ldquo;barcode labels&rdquo; of volumes in the autochanger's
slots. Many real (tape) autochangers have barcode readers such that
tapes can be given a physical barcode label that identifies the tape.
This allows Bacula to automate the process of creating volume labels.
Vchanger emulates barcodes for the volumes in a virtual autochanger's
slots by listing the volume filenames of mounted magazines. The empty
string is listed for each slot corresponding to a magazine bay in
which no mounted and initialized magazine is &ldquo;inserted&rdquo;,
thus informing Bacula that the slot is empty.</P>
<H3 CLASS="western">A.2. slots Command</H3>
<P CLASS="western" STYLE="margin-top: 0in; margin-bottom: 0in; font-style: normal">
This command simply prints to stdout the total number of slots in all
of the autochanger's magazine bays. Bacula issues this command to
determine how many slots an autochanger has.</P>
<H3 CLASS="western">A.3. load Command</H3>
<P CLASS="western" STYLE="font-style: normal">The load command is
used to &ldquo;load&rdquo; a volume file from a virtual slot into a
virtual drive. A real autochanger does this by physically moving a
tape from a magazine slot and inserting it into a tape drive. Bacula
defines an autochanger as having multiple device nodes, one for the
robotic changer mechanism that shuffles tapes between tape library
slots and a tape drive, and one device for each tape drive the
autochanger has. Bacula relies on an external autochanger script or
program, such as vchanger, to manipulate the robotic changer
mechanism into loading the requested tape into the requested tape
drive. Bacula then reads and writes volumes using the selected tape
drive. For a vchanger autochanger, the device used for reading and
writing volumes is a regular file, rather than the device node of a
tape drive. The file for drive N is named 'symlink/driveN', where
'symlink' is symlink in the autochanger work directory that points to
the mountpoint of the magazine partition containing the requested
volume file. The volume is then &ldquo;loaded&rdquo; into the virtual
drive by renaming the volume file to driveN and saving the currently
loaded volume's filename in a file named loadedN.</P>
<P CLASS="western" STYLE="font-style: normal">Parameter 3 gives the
autochanger slot number of the volume to load, parameter 4 gives the
path to the device that Bacula will read/write and is not used by
vchanger, and parameter 5 gives the drive number of the virtual drive
the volume is to be loaded into. After checking that the drive given
by parameter 5 is not already loaded and the slot given by parameter
3 is not already loaded into another drive, vchanger determines the
magazine that contains the slot and creates, (in the autochanger's
work directory), a symlink to that magazine's mountpoint. The symlink
is given a numerical name equal to the virtual drive number. The
Bacula Storage Daemon is then configured to use 'symlink/driveN' as
the device to read/write.</P>
<H3 CLASS="western">A.4. unload Command</H3>
<P CLASS="western" STYLE="font-style: normal">When drive N is loaded,
the magazine directory containing the slot loaded into drive N will
contain a file named driveN, (the renamed volume file). The contents
of the loadedN file specifies the filename of the volume file that
was renamed to driveN when the virtual drive was loaded. To unload
the virtual drive, vchanger renames the driveN file back to its
original volume filename and erases the contents of the loadedN file.
Additionally, the symlink for the virtual drive is deleted from the
vchanger work directory and the contents of the stateN file in the
work directory is erased.</P>
<H3 CLASS="western"><B>A.5. loaded Command</B></H3>
<P CLASS="western" STYLE="font-weight: normal">This command is issued
to determine which slot, if any, is loaded into a drive. If a drive
is loaded, then the virtual slot number corresponding to the loaded
volume file is written to stdout. If the drive is not loaded, the
string &ldquo;0&rdquo; is written to stdout to inform Bacula that the
drive is not loaded.</P>
<H3 CLASS="western"><B>A.6. initmag Command</B></H3>
<P CLASS="western"><SPAN STYLE="font-weight: normal">This is an
extended command that is not part of the <A HREF="http://www.bacula.org/3.0.x-manuals/en/concepts/concepts/Autochanger_Resource.html#SECTION0018130000000000000000">Bacula
Autochanger Interface</A></SPAN> <SPAN STYLE="font-weight: normal">API,
and is used to initialize one of the magazines defined in the
autochanger configuration file. The format of this command is</SPAN></P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.2in">vchanger -u sd_user -g sd_group config_file initmag mag_bay [-m mag_number]</PRE><P CLASS="western" STYLE="margin-top: 0.08in">
where:</P>
<TABLE WIDTH=664 BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=131>
	<COL WIDTH=533>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">sd_user</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">The user Bacula Storage Daemon runs as</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">sd_group</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">The group Bacula Storage Daemon runs as</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">config_file</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">Path to the autochanger configuration file</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">mag_bay</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">Positive integer magazine bay number 
			</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">mag_number</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">[Optional] specifies the magazine number to be
			assigned to the magazine</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western" STYLE="margin-top: 0.08in">The magazine's index
file is created with the contents being a string of the form
&ldquo;name_mmmm&rdquo;, where 'name' is the name given by the
<I>changer_name</I> directive in the configuration file, and 'mmmm'
is the 4 digit magazine number assigned to the magazine when it was
initialized. If the magazine number is not manually specified on the
command line with the -m flag, then the next available magazine
number is assigned. A file named 'nextmag' in the autochanger's work
directory is used by the <I>initmag</I> command to store the next
available magazine number for the autochanger.</P>
<P CLASS="western" STYLE="margin-top: 0.08in">The optional -m flag is
used to manually assign a particular magazine number to a new
magazine. It is provided to make it easier to replace a defective
removable disk drive, allowing a replacement to be assigned the same
magazine number as the failed disk drive. It should be used with
care, as it is important that all magazines for a particular
autochanger have unique magazine numbers in order to prevent
duplicate volume filenames.</P>
<P CLASS="western" STYLE="margin-top: 0.08in">Along with the index
file, empty volume files are created for each of the magazine's
slots. Note that these empty files cannot be used as backup volumes
until after a Bacula volume label has been written to them using the
<I>label</I> or <I>label barcodes</I> command in the <A HREF="http://www.bacula.org/3.0.x-manuals/en/console/console/index.html">Bacula
console</A> after the magazine is initialized.</P>
<H3 CLASS="western"><A NAME="command_listmags"></A><B>A.7. listmags
Command</B></H3>
<P CLASS="western"><SPAN STYLE="font-weight: normal">This is an
extended command that is not part of the <A HREF="http://www.bacula.org/3.0.x-manuals/en/concepts/concepts/Autochanger_Resource.html#SECTION0018130000000000000000">Bacula
Autochanger Interface</A></SPAN> <SPAN STYLE="font-weight: normal">API,
and is used to list the autochanger's magazine bay contents. The
format of this command is</SPAN></P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.2in">vchanger -u sd_user -g sd_group config_file listmags</PRE><P CLASS="western" STYLE="margin-top: 0.08in">
where:</P>
<TABLE WIDTH=664 BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=131>
	<COL WIDTH=533>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">sd_user</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">The user Bacula Storage Daemon runs as</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">sd_group</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">The group Bacula Storage Daemon runs as</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">config_file</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">Path to the autochanger configuration file</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western" STYLE="margin-top: 0.08in">The contents of each
magazine bay are written to stdout, one line per bay. The format of
an output line is:</P>
<PRE CLASS="western" STYLE="margin-top: 0.01in; margin-bottom: 0.2in">bay:name:mag:mountpoint</PRE><P CLASS="western" STYLE="margin-top: 0.08in">
where:</P>
<TABLE WIDTH=664 BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=131>
	<COL WIDTH=533>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">bay</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">The magazine bay number</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">name</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">The name of the owning autochanger if an
			initialized magazine is inserted, else blank if no magazine is
			inserted or the magazine is uninitialized</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">mag</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">Positive magazine number assigned to the
			inserted magazine. If no mounted magazine is inserted then mag =
			-1. If a mounted magazine is inserted, but has not yet been
			initialized, then mag = 0</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=131>
			<P CLASS="col1-western">mountpoint</P>
		</TD>
		<TD WIDTH=533>
			<P CLASS="western">Magazine mountpoint if a mounted magazine is
			inserted, else blank</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western" STYLE="margin-top: 0.08in">.</P>
<P CLASS="western" STYLE="margin-top: 0.08in"><BR><BR>
</P>
</BODY>
</HTML>